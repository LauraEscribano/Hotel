<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Detalles de la Reserva</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <link rel="stylesheet" href="/css/reservation.css">
</head>

<body>

  <!-- Header -->

  <%- include('../partials/header') %>


    <!-- ========================== SECCIÓN 1: BARRA DE PROGRESO ========================== -->

    <div class="container mt-5">
      <div class="booking-progress mb-5">
        <div class="row">
          <div class="col-12">
            <div class="progress-steps">
              <div class="progress-bar"></div>
              <div class="step">
                <span class="step-number">1</span>
                <span class="step-title">Selección de Habitación</span>
              </div>
              <div class="step active">
                <span class="step-number">2</span>
                <span class="step-title">Datos del Cliente</span>
              </div>
              <div class="step">
                <span class="step-number">3</span>
                <span class="step-title">Confirmación de Reserva</span>
              </div>
            </div>
          </div>
        </div>
      </div><br>

      <!-- ========================== FIN DE SECCIÓN 1: BARRA DE PROGRESO ========================== -->

      <!-- ========================== SECCIÓN 2: RESERVA ========================== -->

      <!-- Título principal -->

      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">
          <i class="fas fa-edit me-2"></i>Confirmación de Datos de la Reserva
        </h1>
        <p class="lead text-muted">Revisa los detalles de tu estancia y los datos del cliente antes de proceder a la
          confirmación final.</p>
      </div>

      <!-- Botón volver -->
      <% if (!user) { %>
      <div class="mb-4">
        <a href="javascript:history.back()" class="btn btn-volver">
          <i class="fas fa-arrow-left me-2"></i>
          Volver atrás
        </a>
      </div>
      <% } %>
      <!-- Resumen de reserva -->

      <div class="booking-summary card mb-4">
        <div class="card-header">
          <h2 class="mb-0"><i class="fas fa-receipt"></i> Resumen de la Reserva</h2>
        </div>
        <div class="card-body room-details">
          <div class="row gx-4">

            <!-- Estancia -->
            <div class="col-12 col-md-6">
              <div class="date-section ">

                <!-- Header estilo presentación -->
                <div class="header-section d-flex mb-4">
                  <div class="presentation-wrapper d-flex align-items-center">

                    <!-- Icono -->
                    <div class="icon-wrapper bg-navy-gradient mb-0 me-3">
                      <i class="fas fa-calendar-alt"></i>
                    </div>

                    <!-- Títulos -->
                    <div class="titles text-start">
                      <h4 class="presentation-title mb-1">Calendario de Reserva</h4>
                      <div class="underline-decor mb-1"></div>
                      <small class="presentation-subtitle">Periodo de alojamiento</small>
                    </div>

                  </div>
                </div>

                <!-- Detalles alineados a la izquierda -->
                <div class="date-details ps-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-sign-in-alt icon-muted me-2"></i>
                    <span><strong>Entrada:</strong>
                      <%= formatDate(reservation.checkIn) %>
                    </span>
                  </div>
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-sign-out-alt icon-muted me-2"></i>
                    <span><strong>Salida:</strong>
                      <%= formatDate(reservation.checkOut) %>
                    </span>
                  </div>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-moon icon-muted me-2"></i>
                    <span>
                      <%= reservation.nights %> noches
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Habitación -->
            <div class="col-12 col-md-6">
              <div class="room-section">

                <!-- Header estilo presentación -->
                <div class="header-section d-flex  mb-4">
                  <div class="presentation-wrapper d-flex align-items-center">

                    <!-- Icono -->
                    <div class="icon-wrapper bg-navy-gradient mb-0 me-3">
                      <i class="fas fa-hotel"></i>
                    </div>

                    <!-- Títulos -->
                    <div class="titles text-start">
                      <h4 class="presentation-title mb-1">Habitación Reservada</h4>
                      <div class="underline-decor mb-1"></div>
                      <small class="presentation-subtitle">Detalles de tu estancia</small>
                    </div>

                  </div>
                </div>

                <!-- Detalles alineados a la izquierda -->
                <div class="room-info ps-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-star icon-muted me-2"></i>
                    <span><strong>Categoría:</strong>
                      <%= reservation.nomCategoria %>
                    </span>
                  </div>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-door-open icon-muted me-2"></i>
                    <span><strong>Cantidad:</strong>
                      <%= reservation.rooms %> hab.
                    </span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
        <hr class="my-0">
        <div class="price-breakdown card-footer">
          <div class="price-item text-end">
            <input type="hidden" id="basePrice" value="<%= parseInt(reservation.totalPrice) %>">
            <span class="price-label">Precio total</span>
            <span class="price-value" id="priceValue">
              <%= reservation.totalPrice %>€
            </span>
          </div>
        </div>
      </div>


      <% if (isAuthenticated && clientData) { %>

        <!-- Datos del Cliente -->

        <div class="booking-summary card mb-4">
          <div class="card-header section-header">
            <h2 class="mb-0"><i class="fas fa-user"></i> Datos del Cliente</h2>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">A continuación se presentan los datos del titular de la reserva. Si son
              correctos, puede proceder con la confirmación.</p>

            <!-- Nombre -->

            <div class="detail-item d-flex align-items-center mb-4">
              <i class="fas fa-user-circle me-3 icon-lg"></i>
              <div>
                <span class="detail-label">Nombre:</span>
                <span class="detail-value text-muted">
                  <%= clientData.nom %>
                    <%= clientData.cognoms %>
                </span>
              </div>
            </div>

            <!-- DNI -->

            <div class="detail-item d-flex align-items-center mb-4">
              <i class="fas fa-id-card me-3 icon-lg"></i>
              <div>
                <span class="detail-label">DNI:</span>
                <span class="detail-value text-muted">
                  <%= clientData.dni %>
                </span>
              </div>
            </div>

            <!-- Email -->

            <div class="detail-item d-flex align-items-center mb-4">
              <i class="fas fa-envelope me-3 icon-lg"></i>
              <div>
                <span class="detail-label">Email:</span>
                <span class="detail-value text-muted">
                  <%= clientData.email %>
                </span>
              </div>
            </div>

          </div>
        </div>

        <!-- Sección de Servicios -->

        <div class="booking-summary card mb-4">
          <div class="card-header section-header">
            <h2 class="mb-0"><i class="fas fa-concierge-bell"></i> Servicios Disponibles</h2>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">Seleccione los servicios adicionales que le gustaría añadir a su reserva. Estos
              servicios se sumarán al precio total de su estancia.</p>
            <% if (hotelServices && hotelServices.length> 0) { %>
              <form id="reservation-form" action="/reservation/confirm" method="POST">
                <% hotelServices.forEach((service, idx)=> { %>
                  <div class="form-check mb-2">
                    <input class="form-check-input service-radio" type="radio" name="selectedServices"
                      value="<%= service.idServei %>" id="service-<%= service.idServei %>"
                      data-preu="<%= parseFloat(service.preu).toFixed(2) %>" <%=idx===0 ? "checked" : "" %>>
                    <label class="form-check-label" for="service-<%= service.idServei %>">
                      <%= service.nomServei %> (+<%= parseFloat(service.preu).toFixed(2) %>€)
                    </label>
                  </div>
                  <% }) %>

                    <input type="hidden" name="servicePrice" value="<%= hotelServices[0].preu %>">
                    <input type="hidden" name="rooms" value="<%= reservation.rooms %>">
                    <input type="hidden" name="nights" value="<%= reservation.nights %>">

              </form>
              <% } else { %>
                <p>No hay servicios disponibles para este hotel.</p>
                <% } %>
          </div>
        </div>


        <!-- Sección de Método de Pago -->

        <div class="booking-summary card mb-4">
          <div class="card-header section-header">
            <h2 class="mb-0"><i class="fas fa-credit-card"></i> Método de Pago</h2>
            <span class="payment-icons ms-auto">
              <i class="fab fa-cc-visa"></i>
              <i class="fab fa-cc-mastercard"></i>
              <i class="fab fa-cc-amex"></i>
            </span>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="cardNumber" class="form-label">Número de Tarjeta</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="cardNumber" placeholder="4242 4242 4242 4242" required>
                  <span class="input-group-text"><i class="fab fa-cc-visa"></i></span>
                </div>
              </div>
              <div class="col-md-3">
                <label for="expiry" class="form-label">Caducidad</label>
                <input type="text" class="form-control" id="expiry" placeholder="MM/AA" required>
              </div>
              <div class="col-md-3">
                <label for="cvc" class="form-label">CVC</label>
                <input type="text" class="form-control" id="cvc" placeholder="123" required>
              </div>
            </div>
          </div>
        </div>

        <!-- Acuerdos Legales -->

        <div class="legal-section mb-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="terms" required>
            <label class="form-check-label" for="terms">
              Acepto los <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#termsModal">Términos y
                Condiciones</a> y la
              <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#privacyModal">Política de
                Cancelación</a>
            </label>
          </div>
        </div>

        <div class="d-flex justify-content-center mt-4">
          <button type="button" class="btn" id="confirmReservationButton">Confirmar Reserva</button>
        </div> <br>

        <!-- Modal de Confirmación de Pago -->

        <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true"
          data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h3 class="modal-title" id="paymentModalLabel">Confirmando tu Reserva...</h3>
              </div><br>
              <div class="modal-body">

                <!-- Pantalla de carga con barra de progreso -->

                <div class="loading-spinner d-flex justify-content-center">
                  <div class="spinner-border custom-spinner" role="status" style="margin-top: 50px;">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                </div>


                <div class="progress-bar-wrapper">
                  <div class="progress-bar" id="progressBar"></div>
                </div>
                <p>Procesando el pago... por favor espera.</p>
              </div>

            </div>
          </div>
        </div>

        <!-- Modal de Reserva Confirmada -->

        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
          aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h3 class="modal-title" id="confirmationModalLabel">Reserva Confirmada</h3>
              </div>
              <div class="modal-body">
                <p class="success-message">
                  ¡Tu reserva ha sido confirmada con éxito! 🎉
                </p>
                <p>Recibirás un correo de confirmación en breve. Gracias por elegirnos.</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success w-40" id="finalSubmitButton">Continuar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Aviso para inicio de sessión o registro -->

        <% } else { %>
          <div class="alert alert-info elegant-alert">
            <p>No has iniciado sesión. Si ya tienes una cuenta, por favor
              <a href="/auth/login?redirect=/reservation/details">inicia sesión aquí</a>.
            </p>
            <p>Si aún no tienes cuenta, por favor
              <a href="/auth/register?redirect=/reservation/details">regístrate aquí</a>.
            </p>
          </div>
          <% } %>

    </div>
    <!-- ========================== FIN DE SECCIÓN 2: RESERVA ========================== -->

    <!-- Footer -->

    <%- include('../partials/footer') %>

      <!-- Simulador de Proceso de Pago -->

      <script>
        document.getElementById('confirmReservationButton').addEventListener('click', function () {
          let myModal = new bootstrap.Modal(document.getElementById('paymentModal'));
          myModal.show();
          let progressBar = document.getElementById('progressBar');
          let width = 0;
          let interval = setInterval(function () {
            if (width >= 100) {
              clearInterval(interval);
              setTimeout(function () {
                myModal.hide();
                let confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                confirmationModal.show();
              }, 500);
            } else {
              width++;
              progressBar.style.width = width + '%';
            }
          }, 30);
        });
      </script>
      <script>
        document.getElementById('finalSubmitButton').addEventListener('click', function (e) {
    e.preventDefault(); // Evita el submit inmediato
    
    // Obtener la instancia del modal de Bootstrap
    const confirmationModal = document.getElementById('confirmationModal');
    const modalInstance = bootstrap.Modal.getInstance(confirmationModal);
    
    // Cerrar el modal correctamente (con animación)
    modalInstance.hide(); 
    
    // Enviar el formulario después de 0.5 segundos
    setTimeout(() => {
        document.getElementById('reservation-form').submit();
    }, 500);
});
      </script>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
      <script src="/js/detailsScript.js"></script>
</body>

</html>